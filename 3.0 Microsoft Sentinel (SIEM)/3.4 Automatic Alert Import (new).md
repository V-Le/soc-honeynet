**Do you need your VMs to be on for this lab?**  
YES (windows-vm, linux-vm)  

### Importing Analytics Rules
 **Microsoft Sentinel > LAW-Cyber-Lab-01 > Configuration > Analytics > Import**
- Download and Import file: **[Sentinel-Analytics-Rules_KQL-Alert-Queries.json](images/Sentinel-Analytics-Rules_KQL-Alert-Queries.json)**
## Understanding Alerts
Select an Alerts and “Edit” it, then inspect the query in Log Analytics Workspace.
Use [ChatGPT](https://chat.openai.com/chat) to understand the rule further.
### Brute Force Success Windows
This query helps **identify successful brute-force attacks** where an attacker made multiple failed login attempts before eventually succeeding in logging in within an hour.  
  
If the same **IP address** failed at least **5 times** before successfully logging in, it may indicate a **compromised account due to password guessing or credential stuffing**.  
  
```
// Brute Force Success Windows
let FailedLogons = SecurityEvent
| where EventID == 4625 and LogonType == 3
| where TimeGenerated > ago(1h)
| summarize FailureCount = count() by AttackerIP = IpAddress, EventID, Activity, LogonType, DestinationHostName = Computer
| where FailureCount >= 5;
let SuccessfulLogons = SecurityEvent
| where EventID == 4624 and LogonType == 3
| where TimeGenerated > ago(1h)
| summarize SuccessfulCount = count() by AttackerIP = IpAddress, LogonType, DestinationHostName = Computer, AuthenticationSuccessTime = TimeGenerated;
SuccessfulLogons
| join kind = inner FailedLogons on DestinationHostName, AttackerIP, LogonType
| project AuthenticationSuccessTime, AttackerIP, DestinationHostName, FailureCount, SuccessfulCount
```

**Failed Logins Detection (`FailedLogons`)**
 - Filters `SecurityEvent` logs where:
	  - `EventID == 4625` (failed logon attempts).
	  - `LogonType == 3` (network logon, typically remote access).
	  - The event occurred within the last hour (`TimeGenerated > ago(1h)`).
 - Groups (summarizes) the failed attempts by IP address (`AttackerIP`), event ID, activity, logon type, and destination host.
 - Keeps only IPs with **5 or more failed login attempts** (`where FailureCount >= 5`).
**Successful Logins Detection (`SuccessfulLogons`)**
 - Filters `SecurityEvent` logs where:
	  - `EventID == 4624` (successful logon).
	  - `LogonType == 3` (network logon).
	  - The event occurred within the last hour.
 - Groups the successful logins by IP address, logon type, destination host, and records the time of successful authentication.
**Joining Failed and Successful Logins (`join kind = inner`)**
 - Joins `FailedLogons` and `SuccessfulLogons` on:
	  - **Attacker IP (`AttackerIP`)**
	  - **Destination Host (`DestinationHostName`)**
	  - **Logon Type (`LogonType`)**
 - This ensures that only attackers who had multiple failed attempts and later successfully logged in are included.
**Final Output (`project`)**
 - Displays the following details:
	  - `AuthenticationSuccessTime` → Time of successful login.
	  - `AttackerIP` → The IP address of the attacker.
	  - `DestinationHostName` → The compromised machine.
	  - `FailureCount` → Number of failed attempts before success.
	  - `SuccessfulCount` → Number of successful logins (typically 1).

### CUSTOM: Malware Detected
This query helps monitor **malware activity on a system** by identifying when Windows Defender detects and responds to threats.  

If there are multiple `1116` events without corresponding `1117` events, it might indicate that Windows Defender **detected a threat but couldn't take action**, possibly due to permission issues or an outdated signature database.  
  
```
Event
| where EventLog == "Microsoft-Windows-Windows Defender/Operational"
| where EventID == "1116" or EventID == "1117"
```
  
Do this for the remaining “CUSTOM” Analytics Rules. Make sure you understand.

Note:
In the next section, we will generate traffic from “attack-vm” to trigger some of these rules.
Many of them will be triggered on their own from live Internet traffic.

We’re going to continue to work with logs from the VMs, so it may be a good idea to leave your VM’s on (unless you’re going to go to bed or something and want to maximize your savings)